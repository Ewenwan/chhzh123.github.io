---
layout: post
title: TVM - GCN
tags: [dl, tvm]
---

本文将介绍如何用TVM Relay (v0.6)定义图卷积神经网络(GCN)，参考自官方教程[*Building a Graph Convolutional Network*](https://docs.tvm.ai/tutorials/frontend/build_gcn.html#sphx-glr-tutorials-frontend-build-gcn-py)，但增添了更多的性能测试比较。

<!--more-->

其实可以将Relay理解为一个深度学习框架，毕竟TensorFlow、PyTorch、MXNet支持的算子它也都基本支持。

这里只考虑最简单的GCN，即

$$
H^{(k+1)}=AH^{(k)}W^{(k)}
=(((W^{(k)})^T(H^{(k)})^T)A^T)^T
\implies
(H^{(k+1)})^T=((W^{(k)})^T(H^{(k)})^T)A^T
$$

之所以要写成后面的转置形式，是因为现在TVM Relay支持的算子库只有**右乘稀疏矩阵**。进而我们可以将GCN[ICLR'17]在DGL-PyTorch和TVM Relay中都搭建出来，然后比较他们的性能，见下面代码。

{% include prism-js.html %}

<pre data-src="{{ site.baseurl }}/files/programs/tvm_gcn.py"></pre>

输出结果如下，可以看到TVM未加任何优化的裸性能其实已经和CPU版本的DGL性能差不多。<font color="blue">（版本号：TVM v0.6、DGL v0.4.2）</font>

```
Print the first five outputs from DGL-PyTorch execution
 tensor([[-2.1450, -1.3411,  3.6003,  0.1190, -0.9690, -1.4138, -1.0221],
        [ 0.6063, -1.1822, -0.3693, -0.9476,  0.5819,  1.2295,  0.2738],
        [-1.0876,  0.0565, -0.2626, -0.9312,  2.7453, -0.0950, -0.6077],
        [-1.4724,  0.0105, -0.1038, -0.2135,  2.2795, -0.5208, -0.5848],
        [-1.6528, -1.2279,  0.0541,  3.6322, -1.6748, -1.6925,  0.1763]])
Test accuracy of DGL results: 81.40%
DGL running time: 6.89 ms
Cannot find config for target=llvm, workload=('dense', (7, 16, 'float32'), (2708, 16, 'float32'), 0, 'float32'). A fallback configuration is used, which may bring great performance regression.
Cannot find config for target=llvm, workload=('dense', (16, 1433, 'float32'), (2708, 1433, 'float32'), 0, 'float32'). A fallback configuration is used, which may bring great performance regression.
Print the first five outputs from TVM execution
 tensor([[-2.1450, -1.3411,  3.6003,  0.1190, -0.9690, -1.4138, -1.0221],
        [ 0.6063, -1.1822, -0.3693, -0.9476,  0.5819,  1.2295,  0.2738],
        [-1.0876,  0.0565, -0.2626, -0.9312,  2.7453, -0.0950, -0.6077],
        [-1.4724,  0.0105, -0.1038, -0.2135,  2.2795, -0.5208, -0.5848],
        [-1.6528, -1.2279,  0.0541,  3.6322, -1.6748, -1.6925,  0.1763]])
Test accuracy of TVM results: 81.40%
Mean inference time (std dev): 6.41 ms (0.11 ms)
```